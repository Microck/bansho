---
phase: 03-authz-rate-limit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bansho/policy/models.py
  - src/bansho/policy/loader.py
  - src/bansho/policy/__init__.py
  - config/policies.yaml
  - tests/test_policy_loader.py
autonomous: true

must_haves:
  truths:
    - "Policy file loads from disk and validates schema"
    - "Unknown/invalid policy results in safe failure (deny by default)"
  artifacts:
    - path: "config/policies.yaml"
      provides: "Default policy configuration"
    - path: "src/bansho/policy/loader.py"
      provides: "Load + validate policy"
  key_links:
    - from: "src/bansho/policy/loader.py"
      to: "config/policies.yaml"
      via: "default path"
      pattern: "policies\\.yaml"
---

<objective>
Create a YAML-based policy schema (roles, tool rules, rate limits) and a safe loader that validates and defaults to deny.

Purpose: Authorization and rate limiting both depend on a trustworthy policy source.
Output: Policy models + loader + starter config.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-authentication/02-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define policy schema models</name>
  <files>src/bansho/policy/models.py
src/bansho/policy/__init__.py</files>
  <action>
Define a minimal, explicit policy schema (pydantic models) that covers AUTHZ + RATE requirements:
- Roles: `admin`, `user`, `readonly`.
- Tool rules: allow-list per role (default deny).
- Rate limits: per api key and per tool, configurable.
- Keep schema predictable; avoid complex match expressions.
  </action>
  <verify>uv run python -c "from bansho.policy.models import Policy; print('ok')"</verify>
  <done>Policy models exist and encode deny-by-default semantics.</done>
</task>

<task type="auto">
  <name>Task 2: Implement YAML loader with safe defaults</name>
  <files>src/bansho/policy/loader.py
tests/test_policy_loader.py</files>
  <action>
Implement `load_policy(path)`:
- Use `yaml.safe_load`.
- Validate against the pydantic models.
- If file missing or invalid: fail closed (raise error that prevents server start).
- Add tests: valid file loads; invalid schema fails; missing file fails.
  </action>
  <verify>uv run pytest -q tests/test_policy_loader.py</verify>
  <done>Policy loader is tested and fails closed for invalid/missing policy.</done>
</task>

<task type="auto">
  <name>Task 3: Add default policy file</name>
  <files>config/policies.yaml</files>
  <action>
Create `config/policies.yaml` starter:
- Default allow-list is empty for `readonly` and `user` (deny by default).
- `admin` allow-list includes all tools (use a wildcard only if the schema explicitly supports it).
- Provide example rate limits (conservative defaults).
  </action>
  <verify>uv run python -c "from bansho.policy.loader import load_policy; load_policy('config/policies.yaml'); print('loaded')"</verify>
  <done>Default policy file loads successfully and is safe by default.</done>
</task>

</tasks>

<verification>
- `uv run pytest -q` passes
</verification>

<success_criteria>
- A validated policy is required to start Bansho, and the default policy denies access unless explicitly allowed.
</success_criteria>

<output>
After completion, create `.planning/phases/03-authz-rate-limit/03-01-SUMMARY.md`
</output>
