---
phase: 03-authz-rate-limit
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/bansho/middleware/authz.py
  - src/bansho/proxy/bansho_server.py
  - tests/test_authz_enforcement.py
autonomous: true

must_haves:
  truths:
    - "Tool-level access is enforced using role from AuthContext"
    - "Unauthorized tool calls return 403 (not 401)"
  artifacts:
    - path: "src/bansho/middleware/authz.py"
      provides: "Authorization check for tool calls"
    - path: "tests/test_authz_enforcement.py"
      provides: "Authz enforcement regression tests"
  key_links:
    - from: "src/bansho/proxy/bansho_server.py"
      to: "src/bansho/middleware/authz.py"
      via: "check before upstream call"
      pattern: "authorize_tool"
---

<objective>
Implement tool-level authorization driven by YAML policies, with deny-by-default enforcement.

Purpose: Prevent authenticated-but-unauthorized access to sensitive tools (AUTHZ-02/03/04).
Output: Authz middleware + wiring + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-authz-rate-limit/03-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement authz middleware</name>
  <files>src/bansho/middleware/authz.py</files>
  <action>
Create `authorize_tool(policy, auth_ctx, tool_name)`:
- If tool is not in allow-list for the role: deny.
- Deny unknown tool names by default (even for `user`/`readonly`).
- Return structured decision info for logging/audit later (allowed/denied, rule matched).
  </action>
  <verify>uv run python -c "print('authz middleware imports')"</verify>
  <done>Authz middleware exists and encodes deny-by-default allow-list checks.</done>
</task>

<task type="auto">
  <name>Task 2: Wire authz into tool calls</name>
  <files>src/bansho/proxy/bansho_server.py</files>
  <action>
Update `tools/call` flow:
- Load policy at startup (single load; not per-request). Support selecting the policy path via env var:
  - Read `BANSHO_POLICY_PATH` (fallback to `config/policies.yaml`).
  - Fail closed if the selected policy path is missing/invalid.
- Before forwarding to upstream, evaluate authz.
- If denied: return 403 (MCP error envelope if applicable).
- Ensure `tools/list` behavior is also safe:
  - Either filter tool list based on role OR return full list but enforce on call.
  - Prefer filtering to reduce discovery of sensitive tools.
  </action>
  <verify>uv run pytest -q tests/test_authz_enforcement.py</verify>
  <done>Unauthorized tool calls are blocked with 403; allowed calls still succeed.</done>
</task>

<task type="auto">
  <name>Task 3: Add authz tests (role matrix)</name>
  <files>tests/test_authz_enforcement.py</files>
  <action>
Add tests:
- Create API keys for `readonly`, `user`, `admin`.
- Configure policy allow-list so only `admin` can call a sensitive tool.
- Assert: readonly/user get 403, admin succeeds.
- If tool list is filtered, assert tool is absent for readonly/user.
  </action>
  <verify>uv run pytest -q</verify>
  <done>Tests cover deny-by-default and role-based tool enforcement.</done>
</task>

</tasks>

<verification>
- `uv run pytest -q` passes
</verification>

<success_criteria>
- Bansho enforces tool-level authorization according to policy and roles.
</success_criteria>

<output>
After completion, create `.planning/phases/03-authz-rate-limit/03-02-SUMMARY.md`
</output>
